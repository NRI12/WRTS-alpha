{% extends "base/instructor_base.html" %}

{% block title %}Thêm học viên - {{ class_obj.class_name }}{% endblock %}

{% block instructor_content %}
<div class="page-header-modern">
    <div class="page-header-content">
        <div class="page-header-text">
            <h1 class="page-header-title">Thêm học viên vào lớp</h1>
            <p class="page-header-subtitle mb-0">
                {{ class_obj.class_name }} - {{ class_obj.class_code }}
            </p>
        </div>
    </div>
</div>

<form method="POST">
    {{ form.hidden_tag() }}
    <div style="display: none;">
        {{ form.student_id() }}
    </div>
    
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-user-graduate text-primary me-2"></i>
                        Chọn học viên
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Tìm kiếm học viên</label>
                        <input type="text" id="studentSearch" class="form-control" placeholder="Nhập tên hoặc mã học viên...">
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label required mb-0">Chọn học viên</label>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllBtn">
                                    <i class="fas fa-check-square me-1"></i>Chọn tất cả
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllBtn">
                                    <i class="fas fa-square me-1"></i>Bỏ chọn
                                </button>
                            </div>
                        </div>
                        <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto; background: #f8f9fa;">
                            {% if available_students %}
                                {% for student in available_students %}
                                <div class="form-check mb-2 student-item" data-name="{{ student.full_name|lower }}" data-username="{{ student.username|lower }}">
                                    <input class="form-check-input" type="checkbox" name="student_ids" value="{{ student.user_id }}" id="student_{{ student.user_id }}">
                                    <label class="form-check-label" for="student_{{ student.user_id }}">
                                        <strong>{{ student.full_name }}</strong>
                                        <span class="text-muted">({{ student.username }})</span>
                                    </label>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted text-center mb-0">Không còn học viên nào có thể thêm</p>
                            {% endif %}
                        </div>
                        <small class="form-text text-muted d-block mt-2">
                            <span id="selectedCount">0</span> học viên đã được chọn
                        </small>
                    </div>
                    
                    <div>
                        <label class="form-label">Ghi chú</label>
                        {{ form.notes(class="form-control", rows="3", placeholder="Ghi chú chung cho tất cả học viên (tùy chọn)...") }}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle text-info me-2"></i>
                        Thông tin lớp
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="text-muted small mb-0">Số lượng hiện tại</label>
                            <span class="fw-bold text-primary">
                                {% set current_count = enrollments|length %}
                                {{ current_count }}/{{ class_obj.max_students }}
                            </span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            {% set current_count = enrollments|length %}
                            {% set percent = (current_count / class_obj.max_students * 100) if class_obj.max_students > 0 else 0 %}
                            {% if percent >= 100 %}
                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ percent }}%"></div>
                            {% elif percent >= 80 %}
                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ percent }}%"></div>
                            {% else %}
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ percent }}%"></div>
                            {% endif %}
                        </div>
                        <small class="text-muted d-block mt-1">
                            {% if current_count >= class_obj.max_students %}
                            <i class="fas fa-exclamation-circle text-danger"></i> Lớp đã đầy
                            {% elif percent >= 80 %}
                            <i class="fas fa-info-circle text-warning"></i> Gần đầy (còn {{ class_obj.max_students - current_count }} chỗ)
                            {% else %}
                            <i class="fas fa-check-circle text-success"></i> Còn {{ class_obj.max_students - current_count }} chỗ trống
                            {% endif %}
                        </small>
                    </div>
                    
                    {% set current_count = enrollments|length %}
                    {% if current_count >= class_obj.max_students %}
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Lớp đã đầy.</strong> Không thể thêm học viên.
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Có thể thêm <strong>{{ class_obj.max_students - current_count }}</strong> học viên nữa.
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body">
                    <h6 class="mb-3">
                        <i class="fas fa-lightbulb text-warning me-2"></i>
                        Lưu ý
                    </h6>
                    <ul class="small mb-0 ps-3">
                        <li class="mb-2">Học viên phải có role STUDENT</li>
                        <li class="mb-2">Kiểm tra cấp độ phù hợp</li>
                        <li>Thông báo sẽ được gửi tự động</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card border-0 shadow-sm mt-4">
        <div class="card-body d-flex justify-content-between">
            <a href="{{ url_for('instructor.class_detail', class_id=class_obj.class_id) }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Quay lại
            </a>
            <button type="submit" class="btn btn-primary btn-lg" {% if enrollments|length >= class_obj.max_students %}disabled{% endif %}>
                <i class="fas fa-user-plus me-2"></i>Thêm học viên
            </button>
        </div>
    </div>
</form>

<style>
.form-label.required::after {
    content: " *";
    color: #dc2626;
}

.student-item {
    padding: 0.5rem;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.student-item:hover {
    background-color: #e9ecef;
}

.student-item.hidden {
    display: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('studentSearch');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const studentItems = document.querySelectorAll('.student-item');
    const selectedCountSpan = document.getElementById('selectedCount');
    
    function updateSelectedCount() {
        const checked = document.querySelectorAll('input[name="student_ids"]:checked').length;
        selectedCountSpan.textContent = checked;
    }
    
    function filterStudents() {
        const searchTerm = searchInput.value.toLowerCase();
        let visibleCount = 0;
        
        studentItems.forEach(item => {
            const name = item.getAttribute('data-name');
            const username = item.getAttribute('data-username');
            
            if (name.includes(searchTerm) || username.includes(searchTerm)) {
                item.classList.remove('hidden');
                visibleCount++;
            } else {
                item.classList.add('hidden');
            }
        });
    }
    
    searchInput.addEventListener('input', filterStudents);
    
    selectAllBtn.addEventListener('click', function() {
        const visibleItems = document.querySelectorAll('.student-item:not(.hidden)');
        visibleItems.forEach(item => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox) checkbox.checked = true;
        });
        updateSelectedCount();
    });
    
    deselectAllBtn.addEventListener('click', function() {
        document.querySelectorAll('input[name="student_ids"]').forEach(cb => {
            cb.checked = false;
        });
        updateSelectedCount();
    });
    
    document.querySelectorAll('input[name="student_ids"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
    
    updateSelectedCount();
});
</script>
{% endblock %}